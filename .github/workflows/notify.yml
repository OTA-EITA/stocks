name: Slack Notification

on:
  workflow_run:
    workflows: ["Stock Data Pipeline"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack on success
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -s -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "📈 株価データ更新完了",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*株価データパイプライン完了*\n実行時刻: `${{ github.event.workflow_run.created_at }}`"
                    }
                  }
                ]
              }'
          else
            echo "No webhook configured"
          fi

      - name: Notify Slack on failure
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -s -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "⚠️ 株価データ更新に失敗しました",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*パイプライン実行失敗*\n実行時刻: `${{ github.event.workflow_run.created_at }}`"
                    }
                  }
                ]
              }'
          fi
